<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Своя игра — Культура и цивилизации</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
    :root {
      --primary-glow: #ffd700;
      --secondary-glow: #4a9eff;
      --bg-dark: #000041ff;
      --bg-mid: #000c8cff;
      --bg-light: #02046eff;
      --text-light: #fff;
      --text-dim: #b0d4ff;
      --success-glow: #28a745;
      --error-glow: #dc3545;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-mid) 50%, var(--bg-dark) 100%);
      color: var(--text-light);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
      position: relative;
      padding: 20px;
    }
    .bg-animation { position: absolute; inset: 0; overflow: hidden; z-index: 0; opacity: 0.25; }
    .bg-symbol {
      position: absolute;
      font-size: 2rem;
      color: var(--primary-glow);
      font-weight: 300;
      animation: floatSymbol 15s infinite linear;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
      user-select: none;
    }
    @keyframes floatSymbol {
      0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
      5% { opacity: 0; }
      15% { opacity: 1; }
      85% { opacity: 1; }
      95% { opacity: 0; }
      100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
    }
    .screen {
      text-align: center;
      z-index: 10;
      position: relative;
      animation: fadeIn 0.8s ease;
      max-width: 1200px;
      width: 100%;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .logo-container { margin-bottom: 2em; }
    .title {
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--primary-glow);
      margin: 0;
      letter-spacing: 12px;
      text-transform: uppercase;
      text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }
    .subtitle {
      font-size: 1.1rem;
      color: #e4e000ff;
      margin-top: 1em;
      font-weight: 300;
      letter-spacing: 2px;
    }
    .settings-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(74, 158, 255, 0.2);
      border: 1px solid rgba(74, 158, 255, 0.4);
      color: var(--primary-glow);
      padding: 0.8em 1.5em;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      z-index: 20;
    }
    .settings-btn:hover {
      background: rgba(74, 158, 255, 0.3);
      transform: translateY(-2px);
    }
    .teams {
      margin: 2em 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2em;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    .team-box {
      background: rgba(74, 158, 255, 0.08);
      border: 1px solid rgba(74, 158, 255, 0.3);
      border-radius: 8px;
      padding: 2em 1.5em;
      transition: all 0.3s ease;
    }
    .team-box:hover {
      background: rgba(74, 158, 255, 0.12);
      border-color: rgba(74, 158, 255, 0.5);
      transform: translateY(-3px);
    }
    .team-label {
      font-size: 0.9rem;
      color: var(--primary-glow);
      margin-bottom: 1em;
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    input, select {
      padding: 0.9em 1.2em;
      border-radius: 6px;
      border: 1px solid rgba(74, 158, 255, 0.4);
      outline: none;
      background: rgba(10, 37, 64, 0.6);
      color: var(--text-light);
      font-size: 1rem;
      width: 100%;
      text-align: center;
      transition: all 0.3s ease;
      font-weight: 300;
    }
    input[type="range"] { padding: 0; }
    input::placeholder { color: rgba(255, 255, 255, 0.4); }
    input:focus, select:focus {
      border-color: var(--secondary-glow);
      background: rgba(10, 37, 64, 0.8);
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    }
    input:disabled { opacity: 0.5; cursor: not-allowed; }
    .buttons { margin-top: 2em; }
    .big-btn {
      background: var(--secondary-glow);
      color: var(--text-light);
      border: none;
      padding: 1em 3em;
      font-size: 1.1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0.5em;
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(74, 158, 255, 0.3);
    }
    .big-btn:hover {
      background: #3a8eef;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
    }
    .hint {
      font-size: 0.95rem;
      color: var(--text-dim);
      margin-top: 2em;
      font-weight: 300;
    }
    .hidden { display: none !important; }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
      z-index: 500;
      backdrop-filter: blur(8px);
    }
    .modal.hidden { opacity: 0; pointer-events: none; }
    .modal-content {
      background: linear-gradient(135deg, #01047e 0%, #020a5f 100%);
      border: 1px solid rgba(255, 215, 0, 0.4);
      border-radius: 12px;
      padding: 1.5em 2.5em;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalAppear 0.4s ease;
      min-width: 400px;
      max-width: 600px;
    }
    @keyframes modalAppear {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal-content h2 {
      font-size: 1.8rem;
      color: var(--primary-glow);
      margin-bottom: 1em;
      font-weight: 400;
      letter-spacing: 2px;
    }
    .settings-group { margin: 1.2em 0; text-align: left; }
    .settings-group label { display: block; color: var(--text-dim); margin-bottom: 0.5em; font-size: 0.9rem; }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background-color: rgba(10, 37, 64, 0.6); transition: .4s; border-radius: 34px; border: 1px solid rgba(74, 158, 255, 0.4); }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--secondary-glow); }
    input:checked + .slider:before { transform: translateX(26px); }
    .coin {
      width: 140px;
      height: 140px;
      position: relative;
      margin: 2em auto;
      transform-style: preserve-3d;
      transition: transform 2.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .face {
      position: absolute; width: 100%; height: 100%; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-weight: 400; font-size: 1.2rem;
      backface-visibility: hidden; background-size: cover; background-position: center;
      box-shadow: 0 8px 30px rgba(74, 158, 255, 0.4); border: 3px solid rgba(255, 215, 0, 0.4); color: var(--text-light);
    }
    .heads { background-image: url('https://media.discordapp.net/attachments/1344289233447419926/1427219340033265794/coin_heads.png?ex=68ee1117&is=68ecbf97&hm=8ba24400fb08c9927b09987c0daafa199b727f2e357cdd30196ca0067460c9c9&=&format=webp&quality=lossless&width=640&height=640'); }
    .tails { transform: rotateY(180deg); background-image: url('https://media.discordapp.net/attachments/1344289233447419926/1427219340574461993/coin_tails.png?ex=68ee1117&is=68ecbf97&hm=08414785dee1287ab484dd629ea1f50e1858f0fb2f212a1c9f175a67f4ab5244&=&format=webp&quality=lossless&width=640&height=640'); }
    .result {
      font-size: 1.4rem; color: var(--primary-glow); margin-top: 1.5em; font-weight: 400;
      animation: resultAppear 0.4s ease; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    @keyframes resultAppear {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .small-btn {
      background: transparent; color: var(--secondary-glow); border: 1px solid var(--secondary-glow);
      padding: 0.8em 1.5em; font-size: 0.9rem; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;
      font-weight: 400; text-transform: uppercase; margin: 0.25em; letter-spacing: 1px;
    }
    .small-btn:hover { background: var(--secondary-glow); color: var(--text-light); transform: translateY(-2px); }
    .small-btn:disabled {
      opacity: 0.4; cursor: not-allowed; border-color: rgba(74, 158, 255, 0.4);
      color: rgba(74, 158, 255, 0.4); background: transparent; transform: none;
    }
    header {
      font-size: 2.5rem; font-weight: 700; color: var(--primary-glow); letter-spacing: 8px; text-transform: uppercase;
      text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3); display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 1.5em; flex-wrap: wrap; gap: 1em;
    }
    header h1 { flex: 1; text-align: center; margin: 0; font-size: 2.8rem; min-width: 200px; }
    #turn-indicator {
      color: var(--primary-glow); font-size: 1.3rem; font-weight: 600; margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    }
    .team {
      font-size: 1.1rem; text-align: center; color: var(--text-light); background: rgba(74, 158, 255, 0.1);
      padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(74, 158, 255, 0.3);
      box-shadow: 0 0 10px rgba(74, 158, 255, 0.2); min-width: 180px; transition: all 0.4s ease;
    }
    .team.active-team {
        background: rgba(255, 215, 0, 0.15); border-color: rgba(255, 215, 0, 0.6);
        transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    }
    .team-name { color: var(--primary-glow); font-weight: 600; margin-bottom: 4px; }
    .team-score-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; }
    .team-score { font-size: 1.3rem; font-weight: 700; }
    .score-btn {
      background: rgba(74, 158, 255, 0.3); border: 1px solid rgba(74, 158, 255, 0.5);
      color: var(--text-light); width: 24px; height: 24px; border-radius: 50%;
      cursor: pointer; font-size: 1rem; line-height: 22px; transition: all 0.2s ease; padding: 0;
    }
    .score-btn:hover { background: var(--secondary-glow); transform: scale(1.1); }
    .team-lifelines {
        font-size: 0.9rem; color: var(--text-dim); margin-top: 8px; display: flex;
        gap: 15px; justify-content: center; align-items: center;
    }
    #board { display: flex; flex-direction: column; gap: 12px; z-index: 10; margin-bottom: 2em; }
    .category-title {
      background: rgba(74, 158, 255, 0.08); border: 1px solid rgba(74, 158, 255, 0.3); border-radius: 8px;
      padding: 8px; font-size: 0.95rem; color: var(--primary-glow); text-align: center; text-transform: uppercase;
      letter-spacing: 0.5px; font-weight: 500; line-height: 1.2;
    }
      .value-btn {
        background: rgba(10, 37, 64, 0.6); border: 1px solid rgba(74, 158, 255, 0.4); color: var(--text-light);
        font-size: 1.1rem; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; text-align: center;
        padding: 0.8em; font-weight: 400;
      }
    .value-btn:hover {
      background: var(--secondary-glow); border-color: var(--secondary-glow);
      transform: translateY(-3px); box-shadow: 0 0 10px rgba(74, 158, 255, 0.4);
    }
    .value-btn.used {
      background: rgba(255, 255, 255, 0.1); color: #777; pointer-events: none; box-shadow: none; transform: none;
    }
    #question-box {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); justify-content: center; align-items: center;
      flex-direction: column; text-align: center; z-index: 100; backdrop-filter: blur(8px); padding: 20px;
    }
    #timer-display {
      position: absolute; top: 30px; font-size: 3rem; color: var(--primary-glow); font-weight: 700;
      text-shadow: 0 0 15px rgba(255,215,0,0.5);
    }
    .modal-timer {
      font-size: 3.5rem;
      color: var(--primary-glow);
      font-weight: 700;
      margin: 0.5em 0;
      text-shadow: 0 0 15px rgba(255,215,0,0.5);
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    #timer-display.low-time { color: var(--error-glow); animation: pulse 1s infinite; }
    #media-container { max-width: 90%; margin: 0 auto 15px; }
    #media-container img { max-width: 100%; max-height: 30vh; border-radius: 8px; border: 2px solid var(--primary-glow); }
    #media-container audio { width: 100%; max-width: 400px; margin-top: 10px; }
    #question {
      font-size: 1.8rem; margin-top: 10px; margin-bottom: 20px; color: var(--primary-glow);
      max-width: 800px; padding: 0 20px;
    }
    .options {
      display: grid; grid-template-columns: repeat(2,1fr); gap: 15px; width: 80%;
      max-width: 700px; margin: 0 auto 20px auto;
    }
    .option-btn {
      background: rgba(10,37,64,0.6); border: 1px solid rgba(74,158,255,0.4); color: var(--text-light);
      border-radius: 6px; padding: 1em; cursor: pointer; transition: all 0.3s ease; font-size: 1rem;
    }
    .option-btn:hover:not(:disabled) { background: var(--secondary-glow); transform: translateY(-2px); }
    .option-btn.fifty-fifty-hidden { visibility: hidden; pointer-events: none; opacity: 0.3; }
    .option-btn.correct { background: rgba(40, 167, 69, 0.6); border-color: var(--success-glow); }
    .option-btn.incorrect { background: rgba(220, 53, 69, 0.6); border-color: var(--error-glow); }
    #host-controls { display: flex; gap: 20px; margin-top: 20px; }
    .host-btn-correct { background-color: var(--success-glow); border-color: var(--success-glow); }
    .host-btn-correct:hover { background-color: #218838; }
    .host-btn-incorrect { background-color: var(--error-glow); border-color: var(--error-glow); }
    .host-btn-incorrect:hover { background-color: #c82333; }
    #lifeline-controls { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    #answer-feedback {
        position: fixed; inset: 0; z-index: 1000; display: flex; justify-content: center; align-items: center;
        font-size: 10rem; font-weight: 900; text-transform: uppercase; animation: feedback-anim 2s forwards; pointer-events: none;
    }
    #answer-feedback.correct { color: var(--success-glow); text-shadow: 0 0 20px var(--success-glow); }
    #answer-feedback.incorrect { color: var(--error-glow); text-shadow: 0 0 20px var(--error-glow); }
    @keyframes feedback-anim {
        0% { transform: scale(0.5); opacity: 0; } 20% { transform: scale(1.1); opacity: 1; }
        80% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; }
    }
    #final-result {
      display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.9); color: var(--primary-glow);
      justify-content: center; align-items: center; flex-direction: column;
      font-size: 2rem; text-shadow: 0 0 15px rgba(255,215,0,0.6);
    }
    .game-controls { margin-top: 1em; display: flex; gap: 1em; justify-content: center; flex-wrap: wrap; }
    .control-btn {
      background: rgba(74, 158, 255, 0.2); border: 1px solid rgba(74, 158, 255, 0.4); color: var(--primary-glow);
      padding: 0.6em 1.2em; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;
    }
    .control-btn:hover { background: rgba(74, 158, 255, 0.3); transform: translateY(-2px); }
    .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .confetti-piece {
      position: fixed; width: 10px; height: 20px; z-index: 9999; top: -20px; opacity: 0;
      animation: confetti-fall 5s linear forwards;
    }
    @keyframes confetti-fall {
        0% { transform: translateY(0vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
    }
    .lifeline-settings {
        display: grid; grid-template-columns: 1fr auto; gap: 10px 20px; align-items: center;
        background: rgba(0,0,0,0.2); padding: 1em; border-radius: 8px;
    }
    .lifeline-settings label { margin: 0; font-size: 1rem; color: var(--text-light); }
    .lifeline-settings select { width: 120px; }
    
    @media (max-width: 768px) {
        body { padding: 10px; } .title { font-size: 2.5rem; letter-spacing: 6px; } .subtitle { font-size: 1rem; }
        .settings-btn { top: 10px; right: 10px; padding: 0.6em 1em; } .teams { grid-template-columns: 1fr; gap: 1.5em; }
        header { flex-direction: column; gap: 1em; margin-bottom: 1em; } header h1 { font-size: 1.8rem; letter-spacing: 4px; order: -1; }
        .team { width: 100%; max-width: 320px; margin: 0 auto; } #board { gap: 15px; }
        #board > div { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .category-title { grid-column: 1 / -1 !important; margin-bottom: 5px; font-size: 1rem; padding: 10px; }
        .value-btn { font-size: 1rem; padding: 0.9em; } #question-box { padding: 15px; }
        #timer-display { font-size: 2.5rem; top: 15px; } #question { font-size: 1.3rem; max-width: 100%; padding: 0; }
        .options { width: 100%; gap: 10px; } .option-btn { font-size: 0.9rem; }
        .modal-content { width: 95%; min-width: 0; padding: 1.5em; } .modal-content h2 { font-size: 1.5rem; }
        #final-result { font-size: 1.5rem; padding: 15px; } #answer-feedback { font-size: 5rem; }
    }
    @media (max-width: 420px) {
        .title { font-size: 2rem; letter-spacing: 4px; }
        .big-btn { padding: 0.8em 1.5em; font-size: 1rem; width: 100%; max-width: 280px; margin: auto; }
        .options { grid-template-columns: 1fr; } #question { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <div class="bg-animation" id="bgAnimation"></div>

  <div id="start-screen" class="screen">
    <button class="settings-btn" onclick="showSettings()">Настройки</button>
    <div class="logo-container">
      <h1 class="title">СВОЯ ИГРА</h1>
      <p class="subtitle">Культура и цивилизации</p>
    </div>
    <div class="teams">
      <div class="team-box">
        <div class="team-label">Команда 1</div>
        <input id="teamA" type="text" placeholder="Введите название команды" />
      </div>
      <div class="team-box">
        <div class="team-label">Команда 2</div>
        <input id="teamB" type="text" placeholder="Введите название команды" />
      </div>
    </div>
    <div class="buttons">
      <button id="confirmBtn" class="big-btn">Подтвердить</button>
      <button id="playBtn" class="big-btn hidden">Бросить жребий</button>
    </div>
    <p class="hint">Введите названия команд для начала игры</p>
  </div>

  <div id="game-screen" class="screen hidden">
    <header>
      <div class="team" id="team1">
        <div class="team-name" id="team1-name"></div>
        <div class="team-score-wrapper">
            <button class="score-btn" onclick="adjustScore('team1', -100)">-</button>
            <div class="team-score" id="team1-score">0</div>
            <button class="score-btn" onclick="adjustScore('team1', 100)">+</button>
        </div>
        <div class="team-lifelines">
          <span>50/50: <b id="team1-fiftyFifty"></b></span>
          <span>Зв0нков: <b id="team1-phoneAFriend"></b></span>
        </div>
      </div>
      <h1>СВОЯ ИГРА</h1>
      <div class="team" id="team2">
        <div class="team-name" id="team2-name"></div>
        <div class="team-score-wrapper">
            <button class="score-btn" onclick="adjustScore('team2', -100)">-</button>
            <div class="team-score" id="team2-score">0</div>
            <button class="score-btn" onclick="adjustScore('team2', 100)">+</button>
        </div>
        <div class="team-lifelines">
          <span>50/50: <b id="team2-fiftyFifty"></b></span>
          <span>Зв0нков: <b id="team2-phoneAFriend"></b></span>
        </div>
      </div>
    </header>
    <div id="turn-indicator"></div>
    <div id="board"></div>
    <div class="game-controls">
      <button class="control-btn" onclick="showSettings()"> Настройки</button>
      <button class="control-btn" onclick="resetGame()"> Новая игра</button>
    </div>
  </div>

  <div class="modal hidden" id="settingsModal">
    <div class="modal-content">
      <h2>Настройки игры</h2>
      <div class="settings-group" style="display: flex; justify-content: space-between; align-items: center;">
          <label for="host-mode-toggle">Режим ведущего (устный ответ):</label>
          <label class="switch">
              <input type="checkbox" id="host-mode-toggle">
              <span class="slider"></span>
          </label>
      </div>
      <div class="settings-group">
        <label for="volume-control">Громкость музыки:</label>
        <input type="range" id="volume-control" min="0" max="1" step="0.05" value="0.1">
      </div>
      <div class="settings-group">
        <label>Количество подсказок на команду:</label>
        <div class="lifeline-settings">
          <label for="lifelines-count-fifty">50/50</label>
          <select id="lifelines-count-fifty">
            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="unlimited">∞</option>
          </select>
          <label for="lifelines-count-phone"> Звонок другу</label>
          <select id="lifelines-count-phone">
            <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="unlimited">∞</option>
          </select>
        </div>
      </div>
      <div class="settings-group">
        <label for="answer-time">Время на ответ (секунд):</label>
        <select id="answer-time">
          <option value="15">15</option><option value="30" selected>30</option><option value="45">45</option><option value="60">60</option><option value="unlimited">Без ограничений</option>
        </select>
      </div>
      <div class="settings-group">
        <label for="penalty-mode">Штраф за неправильный ответ:</label>
        <select id="penalty-mode">
          <option value="none" selected>Без штрафа</option><option value="half">Половина стоимости</option><option value="full">Полная стоимость</option>
        </select>
      </div>
      <button class="small-btn" onclick="saveSettings()">Сохранить</button>
      <button class="small-btn" onclick="closeSettings()">Закрыть</button>
    </div>
  </div>

  <div class="modal hidden" id="coinModal">
    <div class="modal-content">
      <h2>Определяем первый ход</h2>
      <div class="coin" id="coin">
        <div class="face heads"></div>
        <div class="face tails"></div>
      </div>
      <div class="result" id="coinResult"></div>
      <button id="coinOk" class="small-btn hidden">Продолжить</button>
    </div>
  </div>

  <div class="modal hidden" id="catModal">
    <div class="modal-content">
        <h2 style="font-size: 3rem; margin-bottom: 0.2em;"></h2>
        <h2>Кот в мешке!</h2>
        <p id="catTeamMessage" style="color: var(--text-dim); margin-bottom: 1.5em;"></p>
        <div class="buttons">
            <button class="big-btn" onclick="handleCatChoice('self')">Отвечаем сами</button>
            <button class="big-btn" id="giveCatBtn" onclick="handleCatChoice('opponent')">Отдать сопернику</button>
        </div>
    </div>
  </div>

  <!-- ИЗМЕНЕНО: Новая структура модального окна для звонка другу -->
  <div class="modal hidden" id="phoneAFriendModal">
    <div class="modal-content">
        <h2 style="font-size: 3rem; margin-bottom: 0.2em;">📞</h2>
        <h2>Звонок другу</h2>
        <p style="color: var(--text-dim); font-size: 1.2rem;">Идет звонок... У вас есть 1 минута.</p>
        <div id="phoneTimerDisplay" class="modal-timer">60</div>
        <div class="buttons">
            <button class="big-btn" onclick="closePhoneAFriendModal()">Продолжить</button>
        </div>
    </div>
  </div>

  <div id="question-box">
    <div id="timer-display"></div>
    <div id="media-container"></div>
    <div id="question"></div>
    <div class="options" id="options"></div>
    <div id="host-controls" class="hidden">
        <button class="big-btn host-btn-correct" onclick="hostCheckAnswer(true)">✅ Верно</button>
        <button class="big-btn host-btn-incorrect" onclick="hostCheckAnswer(false)">❌ Неверно</button>
    </div>
    <div id="lifeline-controls">
      <button id="fifty-fifty-btn" class="small-btn">50/50</button>
      <button id="phone-a-friend-btn" class="small-btn"> Звонок другу</button>
    </div>
  </div>

  <div id="final-result"></div>

  <audio id="bg-music" src="https://www.myinstants.com/media/sounds/music-box-game-over-sound-effect-hd.mp3" loop></audio>

  <script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(frequency, duration, type = 'sine') {
      try {
        const oscillator = audioContext.createOscillator(); const gainNode = audioContext.createGain();
        oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
        oscillator.frequency.value = frequency; oscillator.type = type;
        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + duration);
      } catch(e) { console.warn("Web Audio API not supported."); }
    }
    const playClick = () => playSound(600, 0.08, 'triangle');
    const playSuccess = () => { playSound(523, 0.1); setTimeout(() => playSound(783, 0.15), 120); };
    const playError = () => playSound(200, 0.2, 'square');
    const bgAnimation = document.getElementById('bgAnimation');
    const culturalSymbols = ['🏛️','📜','🏺','🎭','🗿','☥','☯️','⚜️','✡️','☪️','🕉️','☮️','✒️','🎨','🎼'];
    for (let i = 0; i < 25; i++) {
      const symbol = document.createElement('div'); symbol.className = 'bg-symbol';
      symbol.textContent = culturalSymbols[Math.floor(Math.random() * culturalSymbols.length)];
      symbol.style.left = `${Math.random() * 95}%`; symbol.style.animationDuration = `${Math.random() * 10 + 10}s`;
      symbol.style.fontSize = `${Math.random() * 1.8 + 0.9}rem`; symbol.style.animationDelay = `-${Math.random() * 15}s`;
      bgAnimation.appendChild(symbol);
    }
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; }
      return newArray;
    }
    function triggerConfetti() {
        const colors = ['#ffd700', '#4a9eff', '#ff4d4d', '#4dd0e1', '#f48fb1'];
        for (let i = 0; i < 150; i++) {
            const confetti = document.createElement('div'); confetti.className = 'confetti-piece';
            confetti.style.left = `${Math.random() * 100}vw`; confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = `${Math.random() * 3 + 4}s`; confetti.style.animationDelay = `${Math.random() * 3}s`;
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`; document.body.appendChild(confetti);
            confetti.addEventListener('animationend', () => confetti.remove());
        }
    }
    const categories = [ { id: "Первобытность", questions: [ { value: 200, question: "Какой период человеческой истории предшествует появлению письменности?", correct: "Первобытность", options: ["Античность", "Средневековье", "Первобытность", "Новое время"] }, { value: 400, question: "Как назывались древнейшие орудия труда человека?", correct: "Каменные", options: ["Железные", "Каменные", "Бронзовые", "Медные"] }, { value: 600, question: "Какая река считалась священной в Древней Индии?", correct: "Ганг", options: ["Нил", "Тигр", "Ганг", "Янцзы"] }, { value: 800, question: "Как назывались древние общины, объединённые кровным родством?", correct: "Родовые общины", options: ["Племена", "Родовые общины", "Города", "Империи"] }, { value: 1000, question: "Какой археологический памятник Казахстана относится к эпохе бронзы и связан с культурой Андроновцев?", correct: "Бегазы-Дандыбаевская культура", options: ["Андроновская культура", "Бегазы-Дандыбаевская культура", "Саки", "Согдиана"] } ] }, { id: "Рабовладельчество", questions: [ { value: 200, question: "Какая река была основой жизни и процветания Древнего Египта?", correct: "Нил", options: ["Тигр", "Евфрат", "Нил", "Инд"] }, { value: 400, question: "В какой древней стране, согласно легенде, находились Висячие сады Семирамиды?", correct: "Вавилон", options: ["Египет", "Ассирия", "Вавилон", "Персия"] }, { value: 600, question: "Какая система письма, основанная на выдавливании знаков на глине, существовала в Шумере?", correct: "Клинопись", options: ["Иероглифы", "Клинопись", "Алфавит", "Пиктография"] }, { value: 800, question: "Какие древние племена Казахстана вели кочевой образ жизни и были известны своими бронзовыми изделиями?", correct: "Саки", options: ["Скифы", "Саки", "Уйсунь", "Кангюй"] }, { value: 1000, question: "Как называется священный текст зороастризма, древней религии Персии?", correct: "Авеста", options: ["Талмуд", "Авеста", "Веды", "Типитака"] } ] }, { id: "Античность", questions: [ { value: 200, question: "Какие города-государства Древней Греции назывались полисами?", correct: "Полисы", options: ["Провинции", "Полисы", "Империи", "Феодальные владения"] }, { value: 400, question: "Кто был богом грома и молний в древнегреческой мифологии?", correct: "Зевс", options: ["Аполлон", "Арес", "Зевс", "Посейдон"] }, { value: 600, question: "Как называлась главная торговая и общественная площадь в Древних Афинах?", correct: "Агора", options: ["Форум", "Агора", "Акрополь", "Колизей"] }, { value: 800, question: "Какой философ, автор труда «Государство», был учеником Сократа?", correct: "Платон", options: ["Аристотель", "Платон", "Сократ", "Геродот"] }, { value: 1000, question: "Как звали философа-киника, который, по легенде, жил в бочке?", correct: "Диоген", options: ["Пифагор", "Диоген", "Эпикур", "Зенон"] } ] }, { id: "Средневековье", questions: [ { value: 200, question: "Какой архитектурный стиль, характеризующийся массивными стенами и полукруглыми арками, доминировал в Европе в X–XII веках?", correct: "Романский стиль", options: ["Готика", "Барокко", "Романский стиль", "Ренессанс"] }, { value: 400, audio: "https://www.myinstants.com/media/sounds/prokofiev-dance-of-the-knights.mp3", question: "Послушайте фрагмент. Какой композитор написал знаменитый «Танец рыцарей»?", correct: "Сергей Прокофьев", options: ["Пётр Чайковский", "Дмитрий Шостакович", "Сергей Прокофьев", "Игорь Стравинский"] }, { value: 600, question: "Какая религия стала господствующей в Европе в Средние века?", correct: "Христианство", options: ["Ислам", "Буддизм", "Христианство", "Иудаизм"] }, { value: 800, question: "Как назывался военно-монашеский орден, основанный в Палестине для защиты паломников?", correct: "Тамплиеры", options: ["Францисканцы", "Тамплиеры", "Доминиканцы", "Госпитальеры"] }, { value: 1000, question: "Кто изобрёл книгопечатание в Европе в середине XV века?", correct: "Иоганн Гутенберг", options: ["Леонардо да Винчи", "Иоганн Гутенберг", "Марко Поло", "Роджер Бэкон"] } ] }, { id: "Возрождение", questions: [ { value: 200, question: "Кто является автором знаменитой картины «Мона Лиза» (Джоконда)?", correct: "Леонардо да Винчи", options: ["Рафаэль", "Микеланджело", "Леонардо да Винчи", "Боттичелли"] }, { value: 400, question: "Какое религиозное движение эпохи Возрождения стремилось к обновлению христианской церкви?", correct: "Реформация", options: ["Контрреформация", "Реформация", "Ренессанс", "Гуманизм"] }, { value: 600, question: "Кто написал политический трактат «Государь», где цель оправдывает средства?", correct: "Никколо Макиавелли", options: ["Эразм Роттердамский", "Никколо Макиавелли", "Томас Мор", "Петрарка"] }, { value: 800, question: "Какой художник и скульптор расписал потолок Сикстинской капеллы в Ватикане?", correct: "Микеланджело", options: ["Леонардо да Винчи", "Микеланджело", "Рафаэль", "Тициан"] }, { value: 1000, question: "Какой английский драматург является автором трагедий «Гамлет» и «Ромео и Джульетта»?", correct: "Уильям Шекспир", options: ["Кристофер Марло", "Уильям Шекспир", "Бен Джонсон", "Джон Мильтон"] } ] }, { id: "Новое и новейшее время", questions: [ { value: 200, question: "В каком веке произошла Великая французская революция?", correct: "XVIII век", options: ["XVII век", "XVIII век", "XIX век", "XVI век"] }, { value: 400, question: "Как называется знаменитое произведение Людвига ван Бетховена?", correct: "Лунная соната", options: ["Пасторальная симфония", "Лунная соната", "Ода к радости", "Пятая симфония"] }, { value: 600, image: "https://media.discordapp.net/attachments/1344289233447419926/1427219339567829076/van_gogh.jpg?format=webp&width=1010&height=800", question: "Кто является автором этой картины в стиле постимпрессионизма?", correct: "Винсент ван Гог", options: ["Клод Моне", "Поль Гоген", "Винсент ван Гог", "Поль Сезанн"] }, { value: 800, question: "Кто создал картину «Свобода, ведущая народ», посвящённую Июльской революции 1830 года?", correct: "Эжен Делакруа", options: ["Франсиско Гойя", "Эжен Делакруа", "Жак-Луи Давид", "Теодор Жерико"] }, { value: 1000, question: "Какой философ, автор «Критики чистого разума», является центральной фигурой немецкой классической философии?", correct: "Иммануил Кант", options: ["Вольтер", "Иммануил Кант", "Гегель", "Руссо"] } ] }, { id: "XX век и современность", questions: [ { value: 200, question: "Кто является автором картины «Чёрный квадрат»?", correct: "Казимир Малевич", options: ["Василий Кандинский", "Казимир Малевич", "Марк Шагал", "Пабло Пикассо"] }, { value: 400, question: "Какое направление в искусстве, основанное Пикассо и Браком, изображало объекты в виде геометрических форм?", correct: "Кубизм", options: ["Кубизм", "Сюрреализм", "Футуризм", "Экспрессионизм"] }, { value: 600, question: "Кто изобрёл первый телефон?", correct: "Александр Белл", options: ["Томас Эдисон", "Александр Белл", "Никола Тесла", "Гульельмо Маркони"] }, { value: 800, question: "Какой испанский художник-сюрреалист известен своими работами с «плавящимися часами»?", correct: "Сальвадор Дали", options: ["Хоан Миро", "Пабло Пикассо", "Сальвадор Дали", "Рене Магритт"] }, { value: 1000, question: "Какое культурное явление, отрицающее классические каноны и ищущее новые формы, объединяет модернизм, авангард и постмодерн?", correct: "Постмодернизм", options: ["Соцреализм", "Постмодернизм", "Метамодернизм", "Неоклассицизм"] } ] } ];
    
    function deepCopy(obj) { return JSON.parse(JSON.stringify(obj)); }
    function randomizeSpecialQuestions(categoriesData) {
        const NUM_CATS = 7; 
        const allQuestions = [];
        const possibleValues = [200, 400, 600, 800, 1000];
        const possibleCatTopics = ["История Искусств", "Древние Технологии", "Мировые Религии", "Великие Правители", "Забытые Империи", "Культурное Наследие"];
        categoriesData.forEach(category => {
            category.questions.forEach(question => {
                delete question.type; delete question.catTopic; delete question.catValue;
                allQuestions.push(question);
            });
        });
        shuffleArray(allQuestions);
        for (let i = 0; i < NUM_CATS && i < allQuestions.length; i++) {
            const q = allQuestions[i];
            q.type = 'cat';
            q.catTopic = possibleCatTopics[Math.floor(Math.random() * possibleCatTopics.length)];
            q.catValue = possibleValues[Math.floor(Math.random() * possibleValues.length)];
        }
        return categoriesData;
    }

    const teamAInput = document.getElementById("teamA"), teamBInput = document.getElementById("teamB");
    const confirmBtn = document.getElementById("confirmBtn"), playBtn = document.getElementById("playBtn");
    const hint = document.querySelector(".hint"), coinModal = document.getElementById("coinModal");
    const coin = document.getElementById("coin"), coinResult = document.getElementById("coinResult"), coinOk = document.getElementById("coinOk");
    const timerDisplay = document.getElementById('timer-display'), bgMusic = document.getElementById('bg-music');
    const STORAGE_KEY = 'svoyaIgraState_culture_v11_fixed_turns';
    let timerInterval = null, timeLeft = 0;
    // ИЗМЕНЕНО: Добавлены переменные для таймера "Звонка другу"
    let phoneTimerInterval = null, phoneTimeLeft = 0;
    let totalQuestions = categories.reduce((acc, cat) => acc + cat.questions.length, 0);
    
    let gameState = {
        settings: {
            lifelines: { fiftyFifty: 3, phoneAFriend: 1 },
            answerTime: 30, penaltyMode: 'none', hostMode: false, volume: 0.1,
        },
        team1: { name: '', score: 0, lifelines: { fiftyFifty: 3, phoneAFriend: 1 } },
        team2: { name: '', score: 0, lifelines: { fiftyFifty: 3, phoneAFriend: 1 } },
        currentTurn: null, currentQuestion: null, answeredQuestions: {}, gameBoardData: null,
        gameStarted: false,
    };

    function saveGameState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); } catch (e) { console.error("Не удалось сохранить состояние игры:", e); } }
    function loadGameState() {
      try {
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
          gameState = JSON.parse(savedState);
          if (gameState.gameStarted) {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            updateScoreboard(); updateTurnText(); buildBoard();
            bgMusic.volume = gameState.settings.volume;
            bgMusic.play().catch(e => {});
          } else {
             teamAInput.value = gameState.team1.name; teamBInput.value = gameState.team2.name;
             if (teamAInput.value && teamBInput.value) confirmBtn.click();
          }
        }
      } catch (e) { console.error("Не удалось загрузить состояние игры:", e); localStorage.removeItem(STORAGE_KEY); }
    }
    
    confirmBtn.addEventListener("click", () => {
      playClick();
      const teamA = teamAInput.value.trim(), teamB = teamBInput.value.trim();
      if (!teamA || !teamB) {
        hint.textContent = "Пожалуйста, заполните названия обеих команд"; hint.style.color = "#ff6b6b"; playError(); return;
      }
      playSuccess();
      gameState.team1.name = teamA; gameState.team2.name = teamB;
      hint.style.color = "#4a9eff"; hint.textContent = `Команды готовы: "${teamA}" против "${teamB}"`;
      confirmBtn.classList.add("hidden"); playBtn.classList.remove("hidden");
      teamAInput.disabled = true; teamBInput.disabled = true;
      saveGameState();
    });

    playBtn.addEventListener("click", () => {
      playClick(); coinModal.classList.remove("hidden"); coinResult.textContent = ""; coinOk.classList.add("hidden");
      coin.style.transform = 'rotateY(0deg)';
      setTimeout(() => {
        const isHeads = Math.random() > 0.5;
        const rotation = (6 + Math.floor(Math.random() * 2)) * 360 + (isHeads ? 0 : 180);
        coin.style.transform = `rotateY(${rotation}deg)`; playSound(440, 2.5, 'sawtooth');
        setTimeout(() => {
          playSuccess();
          gameState.currentTurn = isHeads ? 'team1' : 'team2';
          const winnerName = isHeads ? gameState.team1.name : gameState.team2.name;
          coinResult.textContent = isHeads ? `Выпал ОРЕЛ — начинает "${winnerName}"` : `Выпала РЕШКА — начинает "${winnerName}"`;
          coinOk.classList.remove("hidden"); saveGameState();
        }, 2600);
      }, 400);
    });

    coinOk.addEventListener("click", () => {
      playClick(); coinModal.classList.add("hidden");
      const overlay = document.createElement("div");
      overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;font-size:10rem;color:var(--primary-glow);font-weight:900;";
      document.body.appendChild(overlay); let num = 3;
      const countdown = () => {
        if (num > 0) { overlay.textContent = num; playClick(); num--; setTimeout(countdown, 1000); }
        else {
          overlay.textContent = "СТАРТ!"; playSuccess();
          setTimeout(() => { overlay.remove(); startGame(); }, 800);
        }
      }; countdown();
    });

    function showSettings() {
      playClick();
      document.getElementById('host-mode-toggle').checked = gameState.settings.hostMode;
      document.getElementById('volume-control').value = gameState.settings.volume;
      const parseVal = v => v === Infinity ? 'unlimited' : v;
      document.getElementById('lifelines-count-fifty').value = parseVal(gameState.settings.lifelines.fiftyFifty);
      document.getElementById('lifelines-count-phone').value = parseVal(gameState.settings.lifelines.phoneAFriend);
      document.getElementById('answer-time').value = gameState.settings.answerTime;
      document.getElementById('penalty-mode').value = gameState.settings.penaltyMode;
      document.getElementById('settingsModal').classList.remove('hidden');
    }

    function closeSettings() { playClick(); document.getElementById('settingsModal').classList.add('hidden'); }

    function saveSettings() {
      playClick();
      gameState.settings.hostMode = document.getElementById('host-mode-toggle').checked;
      gameState.settings.volume = document.getElementById('volume-control').value;
      bgMusic.volume = gameState.settings.volume;
      const parseCount = id => { const val = document.getElementById(id).value; return val === 'unlimited' ? Infinity : parseInt(val); };
      gameState.settings.lifelines.fiftyFifty = parseCount('lifelines-count-fifty');
      gameState.settings.lifelines.phoneAFriend = parseCount('lifelines-count-phone');
      gameState.settings.answerTime = document.getElementById('answer-time').value;
      gameState.settings.penaltyMode = document.getElementById('penalty-mode').value;
      if (!gameState.gameStarted) {
        gameState.team1.lifelines = { ...gameState.settings.lifelines }; 
        gameState.team2.lifelines = { ...gameState.settings.lifelines };
      }
      updateScoreboard(); closeSettings(); saveGameState(); playSuccess();
    }
    document.getElementById('volume-control').addEventListener('input', e => { bgMusic.volume = e.target.value; gameState.settings.volume = e.target.value; });

    function startGame() {
      gameState.gameStarted = true; gameState.gameBoardData = randomizeSpecialQuestions(deepCopy(categories));
      bgMusic.play().catch(e => {});
      gameState.team1.lifelines = { ...gameState.settings.lifelines }; gameState.team2.lifelines = { ...gameState.settings.lifelines };
      document.getElementById('start-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden');
      updateScoreboard(); updateTurnText(); buildBoard(); saveGameState();
    }

    function updateTurnText() {
        const currentTeamName = gameState.currentTurn === 'team1' ? gameState.team1.name : gameState.team2.name;
        document.getElementById("turn-indicator").textContent = "Сейчас ходит: " + currentTeamName;
        document.getElementById('team1').classList.toggle('active-team', gameState.currentTurn === 'team1');
        document.getElementById('team2').classList.toggle('active-team', gameState.currentTurn === 'team2');
    }

    function updateScoreboard() {
        const formatLifeline = val => val === Infinity ? '∞' : val;
        ['team1', 'team2'].forEach(teamId => {
            document.getElementById(`${teamId}-name`).textContent = gameState[teamId].name;
            document.getElementById(`${teamId}-score`).textContent = gameState[teamId].score;
            document.getElementById(`${teamId}-fiftyFifty`).textContent = formatLifeline(gameState[teamId].lifelines.fiftyFifty);
            document.getElementById(`${teamId}-phoneAFriend`).textContent = formatLifeline(gameState[teamId].lifelines.phoneAFriend);
        });
    }

    function adjustScore(teamId, amount) {
        playClick(); gameState[teamId].score = Math.max(0, gameState[teamId].score + amount);
        updateScoreboard(); saveGameState();
    }

    function buildBoard() {
      const board = document.getElementById('board'); board.innerHTML = "";
      gameState.gameBoardData.forEach(cat => {
        const row = document.createElement("div");
        row.style.cssText = "display:grid;grid-template-columns:1.5fr repeat(5,1fr);gap:8px;align-items:center;";
        const title = document.createElement("div"); title.className = "category-title"; title.textContent = cat.id; row.appendChild(title);
        cat.questions.forEach(q => {
          const btn = document.createElement("div"); btn.className = "value-btn"; btn.textContent = q.value;
          const key = cat.id + q.value; btn.dataset.key = key;
          if(gameState.answeredQuestions[key]) btn.classList.add('used');
          else btn.onclick = () => onValueClick(key, q);
          row.appendChild(btn);
        }); board.appendChild(row);
      });
    }

    function onValueClick(key, questionData) {
      playClick(); gameState.currentQuestion = { key, ...questionData };
      if (questionData.type === 'cat') {
          playSound(600, 0.5, 'square');
          const currentTeamName = gameState[gameState.currentTurn].name;
          const opponentTeamName = (gameState.currentTurn === 'team1' ? gameState.team2 : gameState.team1).name;
          document.getElementById('catTeamMessage').textContent = `Команда "${currentTeamName}", вы должны решить: будете ли вы отвечать на вопрос из темы "${questionData.catTopic}" стоимостью ${questionData.catValue} очков, или отдадите его команде "${opponentTeamName}"?`;
          document.getElementById('giveCatBtn').textContent = `Отдать команде "${opponentTeamName}"`;
          document.getElementById('catModal').classList.remove('hidden'); return;
      }
      showQuestion(questionData);
    }
    
    function handleCatChoice(choice) {
        playClick();
        if (choice === 'opponent') { gameState.currentTurn = gameState.currentTurn === 'team1' ? 'team2' : 'team1'; updateTurnText(); }
        document.getElementById('catModal').classList.add('hidden');
        gameState.currentQuestion.value = gameState.currentQuestion.catValue;
        showQuestion(gameState.currentQuestion);
    }
    
    function showQuestion(questionData) {
        const mediaContainer = document.getElementById('media-container'); mediaContainer.innerHTML = '';
        if (questionData.image) { const img = document.createElement('img'); img.src = questionData.image; mediaContainer.appendChild(img); }
        if (questionData.audio) { const audio = document.createElement('audio'); audio.controls = true; audio.src = questionData.audio; audio.autoplay = true; mediaContainer.appendChild(audio); }
        document.getElementById('question').textContent = questionData.question;
        const optionsEl = document.getElementById('options'), hostControls = document.getElementById('host-controls'), lifelineControls = document.getElementById('lifeline-controls');
        if (gameState.settings.hostMode) {
            optionsEl.classList.add('hidden'); hostControls.classList.remove('hidden'); lifelineControls.classList.add('hidden');
        } else {
            optionsEl.classList.remove('hidden'); hostControls.classList.add('hidden'); lifelineControls.classList.remove('hidden');
            optionsEl.innerHTML = "";
            shuffleArray(questionData.options).forEach(opt => {
                const btn = document.createElement("button"); btn.className = "option-btn"; btn.textContent = opt;
                btn.onclick = () => checkAnswer(opt); optionsEl.appendChild(btn);
            });
        }
        const currentLifelines = gameState[gameState.currentTurn].lifelines;
        document.getElementById('fifty-fifty-btn').disabled = currentLifelines.fiftyFifty <= 0;
        document.getElementById('phone-a-friend-btn').disabled = currentLifelines.phoneAFriend <= 0;
        document.getElementById('question-box').style.display = "flex";
        startTimer(parseInt(gameState.settings.answerTime));
    }
    
    function checkAnswer(selected) {
        clearInterval(timerInterval);
        const isCorrect = selected === gameState.currentQuestion.correct;
        const { correct } = gameState.currentQuestion;
        Array.from(document.getElementById('options').children).forEach(btn => {
            btn.disabled = true;
            if (btn.textContent === correct) btn.classList.add('correct');
            else if (btn.textContent === selected) btn.classList.add('incorrect');
        });
        processAnswerResult(isCorrect);
    }

    function hostCheckAnswer(isCorrect) { clearInterval(timerInterval); processAnswerResult(isCorrect); }
    function showAnswerFeedback(isCorrect) {
        const feedbackEl = document.createElement('div'); feedbackEl.id = 'answer-feedback';
        feedbackEl.textContent = isCorrect ? 'Верно' : 'Неверно';
        feedbackEl.className = isCorrect ? 'correct' : 'incorrect';
        document.body.appendChild(feedbackEl);
        feedbackEl.addEventListener('animationend', () => feedbackEl.remove());
    }
    
    function processAnswerResult(isCorrect) {
        const { value, key } = gameState.currentQuestion;
        showAnswerFeedback(isCorrect);
        let penalty = 0;
        if (isCorrect) { playSuccess(); gameState[gameState.currentTurn].score += value; }
        else {
            playError();
            if (gameState.settings.penaltyMode === 'half') penalty = Math.floor(value / 2);
            else if (gameState.settings.penaltyMode === 'full') penalty = value;
            if (penalty > 0) gameState[gameState.currentTurn].score = Math.max(0, gameState[gameState.currentTurn].score - penalty);
        }
        updateScoreboard(); gameState.answeredQuestions[key] = true;
        document.querySelector(`[data-key='${key}']`).classList.add('used');
        
        setTimeout(() => {
            document.getElementById('question-box').style.display = "none";
            document.getElementById('media-container').innerHTML = '';
            if (Object.keys(gameState.answeredQuestions).length >= totalQuestions) {
                showWinner();
            } else {
                gameState.currentTurn = gameState.currentTurn === 'team1' ? 'team2' : 'team1';
                updateTurnText();
            }
            saveGameState();
        }, 2500);
    }

    function startTimer(duration) {
        clearInterval(timerInterval);
        timerDisplay.classList.remove('low-time');
        if (gameState.settings.answerTime === 'unlimited') { timerDisplay.textContent = '∞'; return; }
        
        timeLeft = duration;
        timerDisplay.textContent = timeLeft;
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = timeLeft;
            if (timeLeft <= 5 && timeLeft > 0) { timerDisplay.classList.add('low-time'); playSound(800, 0.1, 'square'); }
            if (timeLeft <= 0) {
                clearInterval(timerInterval); playError();
                Array.from(document.getElementById('options').children).forEach(btn => btn.disabled = true);
                processAnswerResult(false);
            }
        }, 1000);
    }

    document.getElementById('fifty-fifty-btn').addEventListener('click', () => {
      playClick(); const teamLifelines = gameState[gameState.currentTurn].lifelines; if (teamLifelines.fiftyFifty <= 0) return;
      if (teamLifelines.fiftyFifty !== Infinity) teamLifelines.fiftyFifty--;
      updateScoreboard(); const correct = gameState.currentQuestion.correct;
      const incorrectOptions = Array.from(document.getElementById('options').children).filter(btn => btn.textContent !== correct);
      shuffleArray(incorrectOptions).slice(0, 2).forEach(btn => btn.classList.add('fifty-fifty-hidden'));
      document.getElementById('fifty-fifty-btn').disabled = true; saveGameState(); playSuccess();
    });

    document.getElementById('phone-a-friend-btn').addEventListener('click', () => {
        playClick(); 
        const teamLifelines = gameState[gameState.currentTurn].lifelines; 
        if (teamLifelines.phoneAFriend <= 0) return;
        
        if (teamLifelines.phoneAFriend !== Infinity) teamLifelines.phoneAFriend--;
        updateScoreboard(); 
        document.getElementById('phone-a-friend-btn').disabled = true;
        
        // Останавливаем основной таймер
        clearInterval(timerInterval);
        
        // Показываем модальное окно и запускаем таймер звонка
        document.getElementById('phoneAFriendModal').classList.remove('hidden');
        startPhoneTimer(60); // 60 секунд = 1 минута
        
        saveGameState(); 
        playSuccess();
    });
    
    // ИЗМЕНЕНО: Новая функция для таймера звонка
    function startPhoneTimer(duration) {
        phoneTimeLeft = duration;
        const display = document.getElementById('phoneTimerDisplay');
        display.textContent = phoneTimeLeft;
        
        clearInterval(phoneTimerInterval); // Очищаем на всякий случай

        phoneTimerInterval = setInterval(() => {
            phoneTimeLeft--;
            display.textContent = phoneTimeLeft;
            if (phoneTimeLeft <= 0) {
                // Время вышло, автоматически закрываем окно
                closePhoneAFriendModal();
            }
        }, 1000);
    }

    // ИЗМЕНЕНО: Обновленная функция закрытия окна
    function closePhoneAFriendModal() {
        playClick();
        clearInterval(phoneTimerInterval); // Останавливаем таймер звонка
        document.getElementById('phoneAFriendModal').classList.add('hidden');
        // Возобновляем основной таймер с оставшимся временем
        startTimer(timeLeft);
    }

    function showWinner() {
      let winnerText;
      if (gameState.team1.score > gameState.team2.score) winnerText = ` Победила команда "${gameState.team1.name}"!`;
      else if (gameState.team2.score > gameState.team1.score) winnerText = ` Победила команда "${gameState.team2.name}"!`;
      else winnerText = " Ничья!";
      const finalResult = document.getElementById('final-result');
      finalResult.innerHTML = `${winnerText}<br><br>Итоговый счёт: ${gameState.team1.score} : ${gameState.team2.score}<br><br><button class="small-btn" onclick="resetGame()">Новая игра</button>`;
      finalResult.style.display = "flex"; triggerConfetti(); playSuccess();
    }

    function resetGame() {
      playClick(); try { localStorage.removeItem(STORAGE_KEY); } catch (e) { console.error("Не удалось очистить состояние игры:", e); }
      location.reload();
    }
    
    window.addEventListener('DOMContentLoaded', loadGameState);
  </script>
</body>
</html>